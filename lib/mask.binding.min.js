(function(e,t){"use strict";function n(e,t){for(var n=0,i=t.length-1;i>n;n++){var r=t[n];null==e[r]&&(e[r]={}),e=e[r]}return e}function i(e,t){for(var n=t.split("."),i=n.length,r=0;i>r;r++){if(null==e)return null;e=e[n[r]]}return e}function r(e,t,n){for(var i=t.split("."),r=i.length,o=0,s=null;r-1>o;o++)s=i[o],null==e[s]&&(e[s]={}),e=e[s];e[i[o]]=n}function o(e,t,r){for(var o=t.split("."),s=o.length,l=0,a=0,h=e;s--&&(h=h[o[l++]],null!=h);)null!=h.__observers&&(a=l,e=h);a>0&&(t=o.slice(a).join(".")),null==e.__observers&&Object.defineProperty(e,"__observers",{value:{__dirty:null},enumerable:!1});var d=e.__observers;if(null!=d[t]){d[t].push(r);var f=i(e,t);return u(f)&&c(f,r),void 0}var p=d[t]=[r],g=t.split("."),v=g.length,m=v>1?n(e,g):e,b=g[v-1],y=m[b];return"length"===b&&u(m)?(c(m,r),void 0):(Object.defineProperty(m,b,{get:function(){return y},set:function(e){if(e!==y){if(y=e,u(e)&&c(e,r),null!=d.__dirties)return d.__dirties[t]=1,void 0;for(var n=0,i=p.length;i>n;n++)p[n](e)}}}),u(y)&&c(y,r),void 0)}function s(e,t,n){for(var r=t.split("."),o=r.length,l=0,a=e;o--&&(a=a[r[l++]],null!=a);)if(null!=a.__observers){s(e,r.slice(l).join("."),n);break}if(null!=e.__observers&&null!=e.__observers[t]){var c=i(e,t);if(2===arguments.length)return delete e.__observers[t],void 0;h(e.__observers[t],n),u(c)&&d(c,n)}}function l(e,t){if(null==t)return e;null==e&&(e={});for(var n in t)e[n]=t[n];return e}function a(e,t){for(var n=t.split("."),i=n.length,r=0;i--;)if(null==(e=e[n[r++]]))return!1;return!0}function u(e){return null!=e&&"object"==typeof e&&null!=e.length&&"function"==typeof e.splice}function h(e){if(null==e)return!1;for(var t,n=0,i=e.length,r=1,o=arguments.length,s=0;i>n;n++)for(t=e[n],r=1;o>r;r++)if(arguments[r]===t){e.splice(n,1),n--,i--,s++;break}return s+1===o}function c(e,t){null==e.__observers&&Object.defineProperty(e,"__observers",{value:{__dirty:null},enumerable:!1});var n=e.__observers.__array;null==n&&(n=e.__observers.__array=[]);for(var i,r=0,o=["push","unshift","splice","pop","shift","reverse","sort"],s=o.length;s>r;r++)i=o[r],e[i]=f(e,e[i],i);n[n.length++]=t}function d(e,t){var n=e.__observers&&e.__observers.__array;if(null!=n)for(var i=0,r=n.length;r>i;i++)if(n[i]===t){n[i]=null;for(var o=i;r>o;o++)n[o]=n[o+1];r--,n.length--}}function f(e,t,n){return function(){return p(e,t,n,H.call(arguments))}}function p(e,t,n,i){var r=e.__observers&&e.__observers.__array,o=t.apply(e,i);if(null==r||0===r.length)return o;if(null!=e.__observers.__dirty)return e.__observers.__dirty=!0,o;for(var s,l=0,a=r.length;a>l;l++)s=r[l],"function"==typeof s&&s(e,n,i);return o}function g(e,t){for(var n=0,i=e.length;i>n;n++)t(e[n])}function v(e){return e.parentNode.removeChild(e)}function m(e){if(null!=e)for(var t=0,n=e.length;n>t;t++)v(e[t])}function b(e,t){return t.parentNode.insertBefore(e,t.nextSibling)}function y(e,t){return t.parentNode.insertBefore(e,t)}function _(e,t,n){return"function"==typeof O?(O(e).on(t,n),void 0):null!=e.addEventListener?(e.addEventListener(t,n,!1),void 0):(e.attachEvent&&e.attachEvent("on"+t,n),void 0)}function C(e,t,n){if(null==e.components)return b(n,e.placeholder);for(var i,r=e.components,o=null,s=!0,l=r.length,a=t;l>a;a++)if(i=r[a].elements,i&&i.length){o=i[0];break}if(null==o)for(s=!1,a=l>t?t:l;--a>-1;)if(i=r[a].elements,i&&i.length){o=i[i.length-1];break}return null==o&&(o=e.placeholder),s?y(n,o):b(n,o)}function x(e,n,i,r,o){return t.render(n,i,r,o,e)}function w(e,t){if(null==e)return!1;m(e.elements),e.elements=null,null!=$&&$.dispose(e);var n=t&&t.components||e.parent&&e.parent.components;return null==n?(console.error("Parent Components Collection is undefined"),!1):h(n,e)}function j(e){null!=$&&$.signal.emitIn(e,"domInsert")}function k(e,t){if("function"==typeof e.dispose){var n=e.dispose;return e.dispose=function(){t.call(this),n.call(this)},void 0}e.dispose=t}function E(e,t,n,i,r){if("."===e)return u(t)&&c(t,r),void 0;var s,l=R(e),h=U(l);if(null!=h){if("string"==typeof h)return a(t,h)&&(s=t),null==s&&a(i,h)&&(s=i),null==s&&(s=t),o(s,h,r),void 0;for(var d,f=null!=h.length&&"function"==typeof h.splice,p=f===!0?h.length:1,g=0;p>g;g++)if(d=f?h[g]:h,null!=d){if("object"==typeof d){if(s=M(d.accessor,t,n,i),null==s||"object"!=typeof s){console.error("Binding failed to an object over accessor",d);continue}d=d.ref}else s=a(t,d)?t:a(i,d)?i:t;o(s,d,r)}}}function N(e,t,n){var i=U(e);if(null!=i){if("string"==typeof i)return s(t,i,n),void 0;for(var r=0,o=i.length;o>r;r++)s(t,i[r],n)}}function T(e,t,n,i,r){var o=0;return function(){if(o++>10)return console.warn("Concurent binder detected",e),void 0;var s=W(e,t,n,i);if(arguments.length>1){var l=H.call(arguments);l[0]=s,r.apply(this,l)}else r(s);o--}}function S(e,t,n){for(var i,r,o,s,l=e.split(";"),a=[],u=0,h=l.length;h>u;u++)i=l[u].split(":"),1===i.length||2===i.length?(o=2==i.length?i[0]:n,r=i[2==i.length?1:0],s=B(r,o,t),null!=s&&a.push(s)):console.error('Too much ":" in a signal def.',l[u]);return a}function B(e,t,n){if(n!==!0)return{signal:e,type:t};var i=e.indexOf(".");return-1===i?(console.error("No pipe name in a signal",e),null):{signal:e.substring(i+1),pipe:e.substring(0,i),type:t}}function I(){}function L(){}function P(){}function A(e,t){if(null==t&&(t=[]),null==e.components)return t;for(var n,i=e.components,r=0,o=i.length;o>r;r++)n=i[r],"validate"!==n.compoName?A(n):t.push(n);return t}var O=window.jQuery||window.Zepto||window.$,$="undefined"!=typeof Compo?Compo:t.Compo||window.Compo,H=Array.prototype.slice,V=t.Utils.Expression,M=V.eval,W=function(e,t,n,i){if("."===e)return t;var r=M(e,t,n,i);return null==r?"":r},R=V.parse,U=V.varRefs,D=function(){function e(e,t,n,i){null==i&&(i=":bind"===n.compoName?"single":"dual");var r,o=n.attr;if(this.node=n,this.controller=n,this.model=e,this.element=t,this.value=o.value,this.property=o.property,this.setter=n.attr.setter,this.getter=n.attr.getter,this.dismiss=0,this.bindingType=i,this.log=!1,this.signal_domChanged=null,this.signal_objectChanged=null,this.locked=!1,null==this.property)switch(t.tagName){case"INPUT":if(r=t.getAttribute("type"),"checkbox"===r){this.property="element.checked";break}this.property="element.value";break;case"TEXTAREA":this.property="element.value";break;case"SELECT":this.domWay=h.SELECT;break;default:this.property="element.innerHTML"}if(o.log&&(this.log=!0,"log"!==o.log&&(this.logExpression=o.log)),o["x-signal"]){var s=S(o["x-signal"],null,"dom")[0];s&&("dom"===s.type?this.signal_domChanged=s.signal:"object"===s.type?this.signal_objectChanged=s.signal:console.error("Type is not supported",s))}if(o["x-pipe-signal"]){var s=S(o["x-pipe-signal"],!0,"dom")[0];s&&("dom"===s.type?this.pipe_domChanged=s:"object"===s.type?this.pipe_objectChanged=s:console.error("Type is not supported",s))}if(o["dom-slot"]){this.slots={};var l=n.parent,a=l.parent;l.parent=this,this.parent=a,this.slots[o["dom-slot"]]=function(e,t){this.domChanged(e,t)}}var u=o["object-pipe-slot"]||o["x-pipe-slot"];if(u){var c=u,d=c.indexOf("."),f=c.substring(0,d),s=c.substring(d+1);this.pipes={},this.pipes[f]={},this.pipes[f][s]=function(){this.objectChanged()},$.pipe.addController(this)}if(o.expression){if(this.expression=o.expression,null==this.value&&"single"!==i){var p=U(this.expression);"string"==typeof p?this.value=p:console.warn("Please set value attribute in DualBind Control.")}}else this.expression=this.value}function n(e){var t=e.expression,n=e.model,i=e.objectChanged=e.objectChanged.bind(e);if(e.binder=T(t,n,e.cntx,e.node,i),E(t,n,e.cntx,e.node,e.binder),"dual"===e.bindingType){var r=e.node.attr;if(!r["change-slot"]&&!r["change-pipe-event"]){var o=e.element,s=r["change-event"]||r.changeEvent||"change",l=e.domChanged.bind(e);_(o,s,l)}}return e.objectChanged(),e}function a(e,t,n){var i=e.slots;(null==i||"function"!=typeof i[t]||i[t].apply(e,n)!==!1)&&null!=e.parent&&a(e.parent,t,n)}var u={};t.registerBinding=function(e,t){u[e]=t},t.BindingProvider=e,e.create=function(t,i,r,o){var s,a=r.attr.bindingProvider,h=null==a?null:u[a];return"function"==typeof h?new h(t,i,r,o):(s=new e(t,i,r,o),null!=h&&l(s,h),n(s))},e.prototype={constructor:e,dispose:function(){N(this.expression,this.model,this.binder)},objectChanged:function(e){if(!(this.dismiss-->0)){if(this.locked===!0)return console.warn("Concurance change detected",this),void 0;if(this.locked=!0,null==e&&(e=this.objectWay.get(this,this.expression)),this.domWay.set(this,e),this.log&&console.log("[BindingProvider] objectChanged -",e),this.signal_objectChanged&&a(this.node,this.signal_objectChanged,[e]),this.pipe_objectChanged){var t=this.pipe_objectChanged;$.pipe(t.pipe).emit(t.signal)}this.locked=!1}},domChanged:function(e,t){if(this.locked===!0)return console.warn("Concurance change detected",this),void 0;this.locked=!0;var n=t||this.domWay.get(this),i=!0;if(this.node.validations)for(var r,o=0,s=this.node.validations.length;s>o;o++)if(r=this.node.validations[o],r.validate(n,this.element,this.objectChanged.bind(this))===!1){i=!1;break}if(i&&(this.dismiss=1,this.objectWay.set(this.model,this.value,n),this.dismiss=0,this.log&&console.log("[BindingProvider] domChanged -",n),this.signal_domChanged&&a(this.node,this.signal_domChanged,[n]),this.pipe_domChanged)){var l=this.pipe_domChanged;$.pipe(l.pipe).emit(l.signal)}this.locked=!1},objectWay:{get:function(e,t){return W(t,e.model,e.cntx,e.controller)},set:function(e,t,n){r(e,t,n)}},domWay:{get:function(e){if(e.getter){var t=e.node.parent;return null==t||"function"!=typeof t[e.getter]?(console.error("Mask.bindings: Getter should be a function",e.getter,e),null):t[e.getter]()}return i(e,e.property)},set:function(e,t){if(e.setter){var n=e.node.parent;if(null==n||"function"!=typeof n[e.setter])return console.error("Mask.bindings: Setter should be a function",e.setter,e),void 0;n[e.setter](t)}else r(e,e.property,t)}}};var h={SELECT:{get:function(e){var t=e.element;return-1===t.selectedIndex?"":t.options[t.selectedIndex].getAttribute("name")},set:function(e,t){for(var n,i=e.element,r=0,o=i.options.length;o>r;r++)if(n=i.options[r],n.getAttribute("name")===t)return i.selectedIndex=r,void 0}}};return l(e,{addObserver:o,removeObserver:s}),e}();t.registerHandler(":visible",I),I.prototype={constructor:I,refresh:function(e,t){t.style.display=W(this.attr.check,e)?"":"none"},renderStart:function(e,t,n){this.refresh(e,n),this.attr.bind&&o(e,this.attr.bind,this.refresh.bind(this,e,n))}},function(){function e(){}t.registerHandler(":bind",e),e.prototype={constructor:e,renderStart:function(e,t,n){this.provider=D.create(e,n,this,"single")},dispose:function(){this.provider&&"function"==typeof this.provider.dispose&&this.provider.dispose()}}}(),t.registerHandler(":dualbind",L),L.prototype={constructor:L,renderEnd:function(e,n,i,r){if(this.components)for(var o,s=0,l=this.components.length;l>s;s++)o=this.components[s],":validate"===o.compoName&&(this.validations||(this.validations=[])).push(o);if(this.provider=D.create(n,r,this),"object"==typeof n.Validate){var a=n.Validate[this.provider.value];"function"==typeof a&&(a=t.getHandler(":validate").createCustom(r,a),(this.validations||(this.validations=[])).push(a))}},dispose:function(){this.provider&&"function"==typeof this.provider.dispose&&this.provider.dispose()}},function(){function e(){}function n(e,t){this.fn=e,this.message=t}function r(e,t,n){console.warn("Validate Notification:",e,t);var i=O(e).next("."+s);0===i.length&&(i=O("<div>").addClass(s).html("<span></span><button>cancel</button>").insertAfter(e)),i.children("button").off().on("click",function(){i.hide(),n&&n()}).end().children("span").text(t).end().show()}function o(e){O(e).next("."+s).hide()}var s="-validate-invalid";t.registerValidator=function(e,t){l[e]=t},t.registerHandler(":validate",e),e.prototype={constructor:e,renderStart:function(e,t,n){this.element=n},validate:function(e,t,n){null==t&&(t=this.element),this.attr&&this.attr.getter&&(e=i({node:this,element:t},this.attr.getter)),null==this.validators&&this.initValidators();for(var s,l=0,a=this.validators.length;a>l;l++)if(s=this.validators[l].validate(e))return r(t,s,n),!1;return o(t),!0},initValidators:function(){this.validators=[];for(var e in this.attr)if("message"!==e)if(e in l!=!1){var t=l[e];this.validators.push(new n(t(this.attr[e],this),this.attr.message))}else console.error("Unknown Validator:",e,this)}},e.createCustom=function(t,i){var r=new e;return r.renderStart(null,t),r.validators=[new n(i)],r},n.prototype.validate=function(e){var t=this.fn(e);return t===!1?this.message||"Invalid - "+e:t};var l={match:function(e){return function(t){return RegExp(e).test(t)}},unmatch:function(e){return function(t){return!RegExp(e).test(t)}},minLength:function(e){return function(t){return t.length>=parseInt(e,10)}},maxLength:function(e){return function(t){return t.length<=parseInt(e,10)}},check:function(e,t){return function(n){return W("x"+e,t.model,{x:n},t)}}}}(),t.registerHandler(":validate:group",P),P.prototype={constructor:P,validate:function(){for(var e,t=A(this),n=0,i=t.length;i>n;n++)if(e=t[n],!e.validate())return!1;return!0}},function(){function e(e,t,n,i,r){return function(t){switch(e){case"node":n.textContent=t;break;case"attr":var o,s,l=typeof n[r];if("boolean"===l)return i=n[r]=!!t,void 0;if("string"===l)return i=n[r]=n[r].replace(i,t),void 0;o=n.getAttribute(r),s=o?o.replace(i,t):t,n.setAttribute(r,s),i=t}}}t.registerUtility("bind",function(t,n,i,r,o,s,l){var a=W(t,n,i,o);"node"===l&&(r=document.createTextNode(a));var u=e(l,t,r,a,s),h=T(t,n,i,o,u);return E(t,n,i,o,h),k(o,function(){N(t,n,h)}),"node"===l?r:a})}(),function(e){function t(){this.attr={"debugger":null,use:null,log:null,"if":null,each:null,visible:null}}e.registerHandler("%%",t);var n=function(){var e={refresh:function(e){this.model=e,this.elements&&(m(this.elements),this.elements=[]),null!=$&&$.dispose(this),y(x(this,this.nodes,this.model,this.cntx),this.placeholder)},dispose:function(){N(this.expr,this.originalModel,this.binder)}};return function(t,n,i,r){var o=t.attr.use;l(t,{expr:o,placeholder:document.createComment(""),binder:T(o,n,i,t,e.refresh.bind(t)),originalModel:n,model:W(o,n,i,t),dispose:e.dispose}),E(o,n,i,t,t.binder),r.appendChild(t.placeholder)}}(),i=function(){return function(e,t,n){function i(e){console.log("Logger > Key: %s, Value: %s",r,e)}var r=e.attr.log,o=T(r,t,n,e,i),s=W(r,t,n,e);E(r,t,n,e,o),k(e,function(){N(r,t,o)}),i(s)}}(),r=function(){function e(e,t){return function(){return e.apply(t,arguments)}}var t={refresh:function(e){(null!=this.elements||e)&&(null==this.elements?(y(x(this,this.template,this.model,this.cntx),this.placeholder),this.$=O(this.elements)):(null==this.$&&(this.$=O(this.elements)),this.$[e?"show":"hide"]()),this.onchange&&this.onchange(e))},dispose:function(){N(this.expr,this.model,this.binder),this.onchange=null,this.elements=null}};return function(n,i,r,o){var s=n.attr["if"];l(n,{expr:s,template:n.nodes,placeholder:document.createComment(""),binder:T(s,i,r,n,e(t.refresh,n)),state:!!W(s,i,r,n)}),n.state||(n.nodes=null),E(s,i,r,n,n.binder),o.appendChild(n.placeholder)}}(),o=function(){var e={refresh:function(e){if(null!=this.elements||!e){if(null==this.elements)return y(x(this,this.template,this.model,this.cntx)),this.$=O(this.elements),void 0;null==this.$&&(this.$=O(this.elements)),this.$[e?"hide":"show"]()}}};return function(t,n,i,r){var o=t.parent.components,s=o&&o[o.length-1];return t.template=t.nodes,t.placeholder=document.createComment(""),null==s||"%%"!==s.compoName||null==s.attr["if"]?(console.error('Mask.Binding: Binded ELSE should be after binded IF - %% if="expression" { ...'),void 0):(s.onchange=e.refresh.bind(t),s.state&&(t.nodes=null),r.appendChild(t.placeholder),void 0)}}(),s=function(){function t(e,t){var n=[];if(null==t||"object"!=typeof t||null==t.length)return n;for(var i,r=0,s=t.length;s>r;r++){switch(i=t[r],typeof i){case"string":case"number":case"boolean":i=t[r]=Object(i)}n[r]=new o(e.template,i,e)}return n}function n(e,t){for(var n=e.components,i=0,r=n.length,o=0,s=null,l=null,a=null,u=document.createDocumentFragment(),h=[];r>i;i++)if(a=n[i],null!=a.elements&&0!==a.elements.length)for(o=0,s=a.elements.length;s>o;o++)l=a.elements[o],l.parentNode.removeChild(l);e:for(o=0,s=t.length;s>o;o++){for(i=0;r>i;i++)if(t[o]===n[i].model){h[o]=n[i];continue e}console.warn("No Model Found for",t[o])}for(i=0,r=h.length;r>i;i++)if(a=h[i],null!=a.elements&&0!==a.elements.length)for(o=0,s=a.elements.length;s>o;o++)l=a.elements[o],u.appendChild(l);e.components=h,y(u,e.placeholder)}function i(e,n,i,o,s){if(null!=n&&null!=i){var l=n,a=n+i;for(a>e.components.length&&(a=e.components.length);a>l;l++)w(e.components[l],e)&&(l--,a--)}if(null!=o&&s&&s.length){var u=new r,h=t(e,s),c=x(u,h),d=u.components;C(e,o,c),j(u),null==e.components&&(e.components=[]),e.components.splice.apply(e.components,[o,0].concat(d))}}var r=e.Dom.Component,o=function(){function e(e,t,n){this.nodes=e,this.model=t,this.parent=n}var t=r.prototype;e.prototype={constructor:s,renderEnd:function(e){this.elements=e}};for(var n in t)e.prototype[n]=t[n];return e}(),s={append:function(t){var n=new o(this.template,t,this);e.render(n,t,null,this.container,this)}},a={refresh:function(e,r,o){var s,l,a=0;if(null==r){if(null!=this.components)for(a=0,l=this.components.length;l>a;a++)s=this.components[a],w(s,this)&&(a--,l--);return this.components=[],this.nodes=t(this,e),y(x(this,this.nodes),this.placeholder),g(this.components,j),void 0}for(l=e.length;l>a;a++)switch(s=e[a],typeof s){case"string":case"number":case"boolean":e[a]=Object(s)}switch(r){case"push":i(this,null,null,e.length,e.slice(e.length-1));break;case"pop":i(this,e.length,1);break;case"unshift":i(this,null,null,0,e.slice(0,1));break;case"shift":i(this,0,1);break;case"splice":var u=o[0],h=1===o.length?this.components.length:o[1],c=o.length>2?e.slice(o[0],o.length-2+o[0]):null;i(this,u,h,u,c);break;case"sort":case"reverse":n(this,e)}},dispose:function(){N(this.expr,this.model,this.refresh)}};return function(e,n,i,r){null==e.nodes&&"undefined"!=typeof Compo&&Compo.ensureTemplate(e);var o=e.attr.each||e.attr.foreach,u=W(o,n,i,e);l(e,{expr:o,binder:T(o,n,i,e,a.refresh.bind(e)),template:e.nodes,container:r,placeholder:document.createComment(""),dispose:a.dispose}),r.appendChild(e.placeholder),E(e.expr,n,i,e,e.binder);for(var h in s)e[h]=s[h];e.nodes=t(e,u)}}(),a=function(){var e={refresh:function(){if(this.refreshing!==!0){this.refreshing=!0;for(var e,t=W(this.attr.visible,this.model,this.cntx,this),n=0,i=this.elements.length;i>n;n++)e=this.elements[n],e.style.display=t?"":"none";this.refreshing=!1}},dispose:function(){N(this.expr,this.model,this.binder)}};return function(t,n,i){var r=t.attr.visible;l(t,{expr:r,binder:T(r,n,i,t,e.refresh.bind(t)),dispose:e.dispose}),E(r,n,i,t,t.binder),e.refresh.call(t)}}();t.prototype={constructor:t,elements:null,renderStart:function(e,t,l){var a=this.attr;if(null==a["debugger"])return null!=a.use?(n(this,e,t,l),void 0):null!=a.log?(i(this,e,t,l),void 0):(this.model=e,null!=a["if"]?(r(this,e,t,l),void 0):null!=a["else"]?(o(this,e,t,l),void 0):((null!=a.each||null!=a.foreach)&&s(this,e,t,l),void 0))},render:null,renderEnd:function(e){this.elements=e,null!=this.attr.visible&&a(this,this.model,this.cntx)}}}(t)})("undefined"==typeof window?global:window,"undefined"==typeof mask?null:mask);